name: Main workflow
on: [push]
jobs:
  run:
    name: Run
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [windows-2019, windows-2022]
    steps:
      - name: Test
        run: |
          Get-ChildItem "C:\Program Files (x86)\Microsoft Visual Studio"
          $vsYear = "${{ matrix.operating-system }}".split('-')[1]
          $currentDirectory = (Get-Location).Path
          $InstallPath = "C:\Program Files\Microsoft Visual Studio\$vsYear\Enterprise"
          if(-not(Test-Path $installPath)) {
            $InstallPath = "C:\Program Files (x86)\Microsoft Visual Studio\$vsYear\Enterprise"
          }
          Set-Location "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"         
          $componentsToRemove= @(
            "Microsoft.VisualStudio.Component.VC.140"
            "Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
          )
          [string]$removeWorkloadArgs = $componentsToRemove | ForEach-Object {" --remove " +  $_}
          [string]$addWorkloadArgs = $componentsToRemove | ForEach-Object {" --add " +  $_}
          $removeArguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$addWorkloadArgs, '--quiet', '--norestart', '--nocache')
          $addArguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$addWorkloadArgs, '--quiet', '--norestart', '--nocache')
          Start-Process -FilePath cmd.exe -ArgumentList $removeArguments -Wait -PassThru -WindowStyle Hidden
          Start-Process -FilePath cmd.exe -ArgumentList $removeArguments -Wait -PassThru -WindowStyle Hidden
          Start-Process -FilePath cmd.exe -ArgumentList $addArguments -Wait -PassThru -WindowStyle Hidden
          Start-Process -FilePath cmd.exe -ArgumentList $addArguments -Wait -PassThru -WindowStyle Hidden
          Set-Location $currentDirectory
          Get-ChildItem $InstallPath
      - name: Test
        run: |
          $MSVCDirectory = vswhere -latest -find "VC\Tools\MSVC"
          Get-ChildItem $MSVCDirectory
          
