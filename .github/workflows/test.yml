name: Runner
on: [push]
jobs:
  runner:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [macos-latest]
    steps:
      - run: |
          set -e
          runner=github
          curl_opts=(-L)
          get() {
            mode=$1
            execute=$2
            file_path=$3
            shift 3
            links=("$@")
            if [ "$mode" = "-s" ]; then
              sudo curl "${curl_opts[@]}" "${links[0]}"
            else
              for link in "${links[@]}"; do
                status_code=$(sudo curl -w "%{http_code}" -o "$file_path" "${curl_opts[@]}" "$link")
                [ "$status_code" = "200" ] && break
              done
              [ "$execute" = "-e" ] && sudo chmod a+x "$file_path"
              [ "$mode" = "-v" ] && echo "$status_code"
            fi
          }
          # Function to fetch a brew tap.
          fetch_brew_tap() {
            tap=$1
            tap_user=$(dirname "$tap")
            tap_name=$(basename "$tap")
            mkdir -p "$tap_dir/$tap_user"
            branch="$(git ls-remote --symref "https://github.com/$tap" HEAD | grep -Eo 'refs/heads/.*' | tr '\t' '\n' | head -1 | cut -d '/' -f 3)"
            get -s -n "" "https://github.com/$tap/archive/$branch.tar.gz" | sudo tar -xzf - -C "$tap_dir/$tap_user"
            sudo mv "$tap_dir/$tap_user/$tap_name-$branch" "$tap_dir/$tap_user/$tap_name"
          }

          # Function to add a brew tap.
          add_brew_tap() {
            tap=$1
            if ! [ -d "$tap_dir/$tap" ]; then
              if [ "${runner:?}" = "self-hosted" ]; then
                brew tap "$tap"
              else
                fetch_brew_tap "$tap" >/dev/null 2>&1
                if ! [ -d "$tap_dir/$tap" ]; then
                  brew tap "$tap"
                fi
              fi
            fi
          }

          # Function to get brew prefix.
          get_brew_prefix() {
            if [ "$(uname -s)" = "Linux" ]; then
              echo /home/linuxbrew/.linuxbrew
            else
              if [ "$(uname -m)" = "arm64" ]; then
                echo /opt/homebrew
              else
                echo /usr/local
              fi
            fi
          }

          # Function to add brew's bin directories to the PATH.
          add_brew_bins_to_path() {
            local brew_prefix=${1:-$(get_brew_prefix)}
            add_path "$brew_prefix"/bin
            add_path "$brew_prefix"/sbin
          }

          # Function to add brew.
          add_brew() {
            brew_prefix="$(get_brew_prefix)"
            if ! [ -d "$brew_prefix"/bin ]; then
              step_log "Setup Brew"
              get -s "" "/tmp/install.sh" "https://raw.githubusercontent.com/Homebrew/install/master/install.sh" | bash -s >/dev/null 2>&1
              add_log "${tick:?}" "Brew" "Installed Homebrew"
            fi
            add_brew_bins_to_path "$brew_prefix"
          }

          # Function to configure brew constants.
          configure_brew() {
            brew_path="$(command -v brew)"
            if [ -z "$brew_path" ]; then
              add_brew
              brew_path="$(command -v brew)"
            fi
            brew_path_dir="$(dirname "$brew_path")"
            brew_prefix="$brew_path_dir"/..
            brew_repo="$brew_path_dir/$(dirname "$(readlink "$brew_path")")"/..
            tap_dir="$brew_repo"/Library/Taps
            core_repo="$tap_dir"/homebrew/homebrew-core

            export HOMEBREW_CHANGE_ARCH_TO_ARM=1
            export HOMEBREW_DEVELOPER=1
            export HOMEBREW_NO_AUTO_UPDATE=1
            export HOMEBREW_NO_ENV_HINTS=1
            export HOMEBREW_NO_INSTALL_CLEANUP=1
            export HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
            export brew_path
            export brew_path_dir
            export brew_prefix
            export brew_repo
            export tap_dir
            export core_repo
          }
          add_brew_tap shivammathur/homebrew-php
          add_brew_tap shivammathur/homebrew-extensions
          brew install shivammathur/php/php@7.1 xdebug@7.1
          brew link --force --overwrite php@7.1
      - run: |  
          php -v php -m
          

