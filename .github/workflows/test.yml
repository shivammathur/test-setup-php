name: Build libjudy

on:
  push:

defaults:
  run:
    shell: cmd

jobs:
  build:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, x86]
        php: [8.3, 8.4]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute virtual inputs
        id: virtuals
        run: |
          set URL=https://raw.githubusercontent.com/winlibs/winlib-builder/refs/heads/master/scripts/compute-virtuals.ps1
          curl -L --fail --retry 5 --retry-delay 5 "%URL%" -o compute_virtuals.ps1
          powershell -File compute_virtuals.ps1 -version ${{ matrix.php }} -arch ${{ matrix.arch }}

      - name: Show computed virtuals
        run: |
          echo vs=${{ steps.virtuals.outputs.vs }}
          echo vsyear=${{ steps.virtuals.outputs.vsyear }}
          echo msts=${{ steps.virtuals.outputs.msts }}
          echo msarch=${{ steps.virtuals.outputs.msarch }}
          echo winsdk=${{ steps.virtuals.outputs.winsdk }}
          echo toolset=${{ steps.virtuals.outputs.toolset }}

      - name: Prepare directories
        run: |
          if not exist downloads mkdir downloads
          if not exist build mkdir build
          if not exist install mkdir install

      - name: Download Judy source tarball
        run: |
          set VER=1.0.5
          set URL=https://downloads.sourceforge.net/project/judy/judy/Judy-%VER%/Judy-%VER%.tar.gz
          echo Downloading %URL%
          curl -L --fail --retry 5 --retry-delay 5 "%URL%" -o "downloads\Judy-%VER%.tar.gz"

      - name: Extract source
        run: |
          set VER=1.0.5
          tar -xzf "downloads\Judy-%VER%.tar.gz" -C build
          if not exist "build\Judy-%VER%\src\build.bat" (
            echo FATAL: build\Judy-%VER%\src\build.bat not found. >&2
            dir /b build\Judy-%VER%\src
            exit /b 1
          )

      - name: Locate the correct vcvarsall.bat (always VS2022)
        id: vc
        shell: pwsh
        run: |
          $vswhere = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vswhere.exe'
          if (!(Test-Path $vswhere)) { throw "vswhere not found at $vswhere" }

          $vsInstall = & $vswhere -latest -products * -version '[17.0,18.0)' -property installationPath
          if ([string]::IsNullOrWhiteSpace($vsInstall)) { throw "VS 2022 not found on this runner" }

          $vcvars = Join-Path $vsInstall 'VC\Auxiliary\Build\vcvarsall.bat'
          if (!(Test-Path $vcvars)) { throw "vcvarsall.bat not found at $vcvars" }

          "vsinstall=$vsInstall" | Out-File -Append $env:GITHUB_OUTPUT
          "vcvars=$vcvars"       | Out-File -Append $env:GITHUB_OUTPUT

      - name: Build libjudy (MSVC)
        shell: cmd
        run: |
          setlocal EnableExtensions EnableDelayedExpansion
      
          rem ---- inputs ----
          set "VER=${{ github.event.inputs.version }}"
          set "MSTS=${{ steps.virtuals.outputs.msts }}"   rem v141/v142/v143
          set "ARCH=${{ matrix.arch }}"
      
          rem ---- map arch for vcvarsall ----
          set "VCVARS_ARCH=%ARCH%"
          if /I "%VCVARS_ARCH%"=="x64" set "VCVARS_ARCH=amd64"
          if /I "%VCVARS_ARCH%"=="x86" set "VCVARS_ARCH=x86"
      
          rem ---- decide vcvars_ver by probing installed toolsets under VS2022 ----
          set "VSINSTALL=${{ steps.vc.outputs.vsinstall }}"
          set "MSVCROOT=%VSINSTALL%\VC\Tools\MSVC"
      
          set "WANT_VER="
          if /I "%MSTS%"=="v141" set "WANT_VER=14.1"
          if /I "%MSTS%"=="v142" set "WANT_VER=14.2"
          if /I "%MSTS%"=="v143" set "WANT_VER=14.3"
      
          rem Probe availability (presence of any 14.3* / 14.2* folder)
          set "HAVE143="
          for /d %%D in ("%MSVCROOT%\14.3*") do set "HAVE143=1"
          set "HAVE142="
          for /d %%D in ("%MSVCROOT%\14.2*") do set "HAVE142=1"
      
          set "VCVARS_VER="
      
          if "%WANT_VER%"=="14.3" (
            if defined HAVE143 (
              set "VCVARS_VER=14.3"
            ) else (
              if defined HAVE142 (
                echo NOTE: v143 not found; falling back to v142
                set "VCVARS_VER=14.2"
              ) else (
                echo NOTE: v143/v142 not found; using default toolset
              )
            )
          ) else (
            if "%WANT_VER%"=="14.2" (
              if defined HAVE142 (
                set "VCVARS_VER=14.2"
              ) else (
                if defined HAVE143 (
                  echo NOTE: v142 not found; using v143
                  set "VCVARS_VER=14.3"
                ) else (
                  echo NOTE: v142/v143 missing; using default toolset
                )
              )
            ) else (
              if "%WANT_VER%"=="14.1" (
                echo NOTE: v141 requested; using default VS toolset unless installed separately.
              )
            )
          )
      
          rem ---- activate VS2022 env (no SDK pin) ----
          if defined VCVARS_VER (
            call "${{ steps.vc.outputs.vcvars }}" %VCVARS_ARCH% -vcvars_ver=%VCVARS_VER%
          ) else (
            call "${{ steps.vc.outputs.vcvars }}" %VCVARS_ARCH%
          )
          if errorlevel 1 exit /b 1
      
          rem ---- locate source dir ----
          set "SRC=build\Judy-%VER%"
          if not exist "%SRC%\src\build.bat" (
            for /d %%D in (build\Judy-*) do (
              if exist "%%D\src\build.bat" set "SRC=%%D"
            )
          )
          if not exist "%SRC%\src\build.bat" (
            echo FATAL: Could not find Judy source (expected build\Judy-%VER%\src\build.bat). >&2
            dir /b build
            exit /b 1
          )
      
          cd /d "%SRC%\src"
          call build.bat
          if errorlevel 1 exit /b 1
      
          if not exist Judy.lib (
            echo FATAL: Judy.lib not produced. Contents of src: >&2
            dir /b
            exit /b 1
          )

      - name: Install headers and libraries
        run: |
          set VER=1.0.5
          set PREFIX=%CD%\install

          if not exist "%PREFIX%\include" mkdir "%PREFIX%\include"
          if not exist "%PREFIX%\lib" mkdir "%PREFIX%\lib"
          if not exist "%PREFIX%\bin" mkdir "%PREFIX%\bin"

          copy /Y "build\Judy-%VER%\src\Judy.h" "%PREFIX%\include\Judy.h" >nul
          copy /Y "build\Judy-%VER%\src\Judy.lib" "%PREFIX%\lib\Judy.lib" >nul
          if exist "build\Judy-%VER%\src\Judy.dll" copy /Y "build\Judy-%VER%\src\Judy.dll" "%PREFIX%\bin\Judy.dll" >nul
          if exist "build\Judy-%VER%\COPYING" copy /Y "build\Judy-%VER%\COPYING" "%PREFIX%\COPYING" >nul

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjudy-1.0.5-${{steps.virtuals.outputs.vs}}-${{matrix.arch}}
          path: install
