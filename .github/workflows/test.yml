
name: Runner Workflow
on:
  push:
jobs:
  runner:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-22.04]
        php: [7.4, '8.0', 8.1, 8.2, 8.3, 8.4, 8.5]
    steps:
        - uses: shivammathur/setup-php@v2
          with:
            php-version: ${{ matrix.php }}
        - run: |            
            php -v
            php -r "if(!in_array('AVIF', Imagick::queryFormats())) { throw new Exception('AVIF not supported in imagick'); }"
            php -r "if(phpversion() >= '8.1' && !gd_info()['AVIF Support']) { throw new Exception('AVIF not supported in gd'); }"
            php -m
        - name: Test avif
          shell: 'php {0}'
          run: |
            <?php
            $avifUrl = 'https://raw.githubusercontent.com/link-u/avif-sample-images/refs/heads/master/fox.profile0.10bpc.yuv420.avif';          
            $avifData = file_get_contents($avifUrl);
            if ($avifData === false) {
                die("Failed to download the image.\n");
            }
            $tempFile = tempnam(sys_get_temp_dir(), 'avif');
            file_put_contents($tempFile, $avifData);
            $imagick = new Imagick($tempFile);
            $imagick->thumbnailImage(200, 200, true, true);
            $imagick->setImageFormat('jpeg');
            $imagick->writeImage('resized_imagick.jpeg');
            $imagick->clear();
            $imagick->destroy();

            if(gd_info()['AVIF Support']) {
              $gdImage = imagecreatefromavif($tempFile);
              if ($gdImage !== false) {
                  $resizedImage = imagescale($gdImage, 200, 200);
                  if ($resizedImage !== false) {
                      imagejpeg($resizedImage, 'resized_gd.jpeg');
                      imagedestroy($resizedImage);
                  }
                  imagedestroy($gdImage);
              }
            }
        - name: Upload Resized Images
          uses: actions/upload-artifact@v4
          with:
            name: resized-images-${{ matrix.php }}-${{ matrix.os }}
            path: '*.jpeg'
