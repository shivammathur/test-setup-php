name: Runner
on:
  push:
jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        php: [8.0, 8.1, 8.2, 8.3, 8.4, 8.5]
    steps:
      - run: |
          sudo mkdir -p /usr/local/opt
          sudo wget https://github.com/ibmdb/db2drivers/raw/refs/heads/main/clidriver/v11.5.9/linuxx64_odbc_cli.tar.gz
          sudo tar xf linuxx64_odbc_cli.tar.gz -C /usr/local/opt
          sudo rm linuxx64_odbc_cli.tar.gz
      - uses: shivammathur/setup-php@verbose
        with:
          php-version: ${{ matrix.php }}
          extensions: lua,ibm_db2
          coverage: pcov
          ini-values: zend.assertions=1
        env:
          IBM_DB2_CONFIGURE_OPTS: --with-IBM_DB2=/usr/local/opt/clidriver
          fail-fast: true
          debug: true
      - run: |
          LD_DEBUG=bindings,libs \
          php -n -d extension=ibm_db2.so -d extension=pdo_sqlsrv.so -r 'echo "hi\n";' 2>&1 \
          | grep -E 'symbol.*SQLAllocHandle|libdb2\.so|libodbc\.so'
        if: failure()
