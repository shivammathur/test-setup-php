name: Main workflow
on: [push]
jobs:
  run:
    name: Run
    runs-on: ${{ matrix.operating-system }}
    strategy:
      fail-fast: false
      matrix:
        operating-system: [windows-2019, windows-2022]
    steps:
      - name: Install components
        run: |
                $vsYear = "${{ matrix.operating-system }}".split('-')[1]
                Write-Host $vsYear
                if($vsYear -eq '2019') {
                  $components = @(
                    "Microsoft.VisualStudio.Component.VC.140"
                    "Microsoft.VisualStudio.Component.VC.v141.x86.x64"
                    "Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
                  )
                } else {
                  $components = @(                  
                    "Microsoft.VisualStudio.Component.VC.140"
                    "Microsoft.VisualStudio.Component.VC.v141.x86.x64"
                    "Microsoft.VisualStudio.ComponentGroup.VC.Tools.142.x86.x64"
                    "Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
                  )
                }
                Function Install-VisualStudio {                
                    Param
                    (
                        [Parameter(Mandatory)] [String] $Version,
                        [Parameter(Mandatory)] [String] $Edition,
                        [Parameter(Mandatory)] [String] $Channel,
                        [Parameter(Mandatory)] [String[]] $RequiredComponents,
                        [String] $ExtraArgs = ""
                    )
                
                    $bootstrapperUrl = "https://aka.ms/vs/${Version}/${Channel}/vs_${Edition}.exe"
                    $channelUri = "https://aka.ms/vs/${Version}/${Channel}/channel"
                    $channelId = "VisualStudio.${Version}.Release"
                    $productId = "Microsoft.VisualStudio.Product.${Edition}"
                
                    Write-Host "Downloading Bootstrapper ..."
                    $bootstrapperFilePath = $env:TEMP/vsinstaller.exe
                    Invoke-WebRequest -Uri $BootstrapperUrl -OutFile $bootstrapperFilePath
                
                    try {
                        $responseData = @{
                            "channelUri" = $channelUri
                            "channelId"  = $channelId
                            "productId"  = $productId
                            "arch"       = "x64"
                            "add"        = $RequiredComponents | ForEach-Object { "$_;includeRecommended" }
                        }
                
                        # Create json file with response data
                        $responseDataPath = "$env:TEMP\vs_install_response.json"
                        $responseData | ConvertTo-Json | Out-File -FilePath $responseDataPath
                
                        $installStartTime = Get-Date
                        Write-Host "Starting Install ..."
                        $bootstrapperArgumentList = ('/c', $bootstrapperFilePath, '--in', $responseDataPath, $ExtraArgs, '--quiet', '--norestart', '--wait', '--nocache' )
                        Write-Host "Bootstrapper arguments: $bootstrapperArgumentList"
                        Start-Process -FilePath cmd.exe -ArgumentList $bootstrapperArgumentList -Wait -PassThru
                    }
                    catch
                    {
                        Write-Host "Failed to install Visual Studio; $($_.Exception.Message)"
                        exit -1
                    }
                }
                Install-VisualStudio -Version $vsYear -Edition Enterprise -Channel release -RequiredComponents $components -ExtraArgs "--allWorkloads --includeRecommended"
      - run: |
          vswhere -nologo -version "[15,16)" -property installationPath -format text
          echo 'default'          
          vswhere -nologo -version "[15,16)" -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[15,16)" -requires Microsoft.VisualStudio.Component.VC.Tools.v142.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[15,16)" -requires Microsoft.VisualStudio.Component.VC.Tools.v141.x86.x64 -property installationPath -format text
          echo 'buildTools'
          vswhere -nologo -version "[15,16)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[15,16)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.Tools.v142.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[15,16)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.Tools.v141.x86.x64 -property installationPath -format text
          echo 'preRelease'
          vswhere -nologo -version "[15,16)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[15,16)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.v142.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[15,16)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.v141.x86.x64 -property installationPath -format text
      - run: |
          vswhere -nologo -version "[16,17)" -property installationPath -format text
          echo 'default'
          vswhere -nologo -version "[16,17)" -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[16,17)" -requires Microsoft.VisualStudio.Component.VC.Tools.v141.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[16,17)" -requires Microsoft.VisualStudio.Component.VC.Tools.v142.x86.x64 -property installationPath -format text
          echo 'buildTools'
          vswhere -nologo -version "[16,17)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[16,17)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.v141.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[16,17)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.v142.Tools.x86.x64 -property installationPath -format text
          echo 'preRelease'
          vswhere -nologo -version "[16,17)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[16,17)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.v141.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[16,17)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.v142.x86.x64 -property installationPath -format text
      - run: |
          vswhere -nologo -version "[17,18)" -property installationPath -format text
          echo 'default'
          vswhere -nologo -version "[17,18)" -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[17,18)" -requires Microsoft.VisualStudio.Component.VC.Tools.v141.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[17,18)" -requires Microsoft.VisualStudio.Component.VC.Tools.v142.x86.x64 -property installationPath -format text
          echo 'buildTools'
          vswhere -nologo -version "[17,18)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[17,18)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.Tools.v141.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[17,18)" -products Microsoft.VisualStudio.Product.BuildTools -requires Microsoft.VisualStudio.Component.VC.Tools.v142.x86.x64 -property installationPath -format text
          echo 'preRelease'
          vswhere -nologo -version "[17,18)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[17,18)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.v141.x86.x64 -property installationPath -format text
          vswhere -nologo -version "[17,18)" -prerelease -requires Microsoft.VisualStudio.Component.VC.Tools.v142.x86.x64 -property installationPath -format text
