name: Build libjudy

on:
  push:

defaults:
  run:
    shell: cmd

jobs:
  build:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, x86]
        php: [8.3, 8.4]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute virtual inputs
        id: virtuals
        run: |
          set URL=https://raw.githubusercontent.com/winlibs/winlib-builder/refs/heads/master/scripts/compute-virtuals.ps1
          curl -L --fail --retry 5 --retry-delay 5 "%URL%" -o compute_virtuals.ps1
          powershell -File compute_virtuals.ps1 -version ${{ matrix.php }} -arch ${{ matrix.arch }}

      - name: Show computed virtuals
        run: |
          echo vs=${{ steps.virtuals.outputs.vs }}
          echo vsyear=${{ steps.virtuals.outputs.vsyear }}
          echo msts=${{ steps.virtuals.outputs.msts }}
          echo msarch=${{ steps.virtuals.outputs.msarch }}
          echo winsdk=${{ steps.virtuals.outputs.winsdk }}
          echo toolset=${{ steps.virtuals.outputs.toolset }}

      - name: Prepare directories
        run: |
          if not exist downloads mkdir downloads
          if not exist build mkdir build
          if not exist install mkdir install

      - name: Download Judy source tarball
        run: |
          set VER=1.0.5
          set URL=https://downloads.sourceforge.net/project/judy/judy/Judy-%VER%/Judy-%VER%.tar.gz
          echo Downloading %URL%
          curl -L --fail --retry 5 --retry-delay 5 "%URL%" -o "downloads\Judy-%VER%.tar.gz"

      - name: Extract source
        run: |
          set VER=1.0.5
          tar -xzf "downloads\Judy-%VER%.tar.gz" -C build
          if not exist "build\Judy-%VER%\src\build.bat" (
            echo FATAL: build\Judy-%VER%\src\build.bat not found. >&2
            dir /b build\Judy-%VER%\src
            exit /b 1
          )

      - name: Locate the correct vcvarsall.bat (always VS2022)
        id: vc
        shell: pwsh
        run: |
          $vswhere = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vswhere.exe'
          if (!(Test-Path $vswhere)) { throw "vswhere not found at $vswhere" }

          $vsInstall = & $vswhere -latest -products * -version '[17.0,18.0)' -property installationPath
          if ([string]::IsNullOrWhiteSpace($vsInstall)) { throw "VS 2022 not found on this runner" }

          $vcvars = Join-Path $vsInstall 'VC\Auxiliary\Build\vcvarsall.bat'
          if (!(Test-Path $vcvars)) { throw "vcvarsall.bat not found at $vcvars" }

          "vsinstall=$vsInstall" | Out-File -Append $env:GITHUB_OUTPUT
          "vcvars=$vcvars"       | Out-File -Append $env:GITHUB_OUTPUT

      - name: Build libjudy (MSVC)
        shell: cmd
        run: |
          setlocal EnableExtensions EnableDelayedExpansion
          set VER=1.0.5

          rem Map matrix arch to vcvarsall arg
          set VCVARS_ARCH=${{ matrix.arch }}
          if /I "%VCVARS_ARCH%"=="x64" set VCVARS_ARCH=amd64
          if /I "%VCVARS_ARCH%"=="x86" set VCVARS_ARCH=x86

          rem Map msts (v141/v142/v143) to -vcvars_ver 14.1/14.2/14.3
          set MSTS=${{ steps.virtuals.outputs.msts }}
          set "VCVARS_VER="
          if /I "%MSTS%"=="v141" set VCVARS_VER=14.1
          if /I "%MSTS%"=="v142" set VCVARS_VER=14.2
          if /I "%MSTS%"=="v143" set VCVARS_VER=14.3

          rem Optional: pin the Windows SDK
          set WINSDK=${{ steps.virtuals.outputs.winsdk }}

          if defined VCVARS_VER (
            if defined WINSDK (
              call "${{ steps.vc.outputs.vcvars }}" %VCVARS_ARCH% -vcvars_ver=%VCVARS_VER% -winsdk=%WINSDK%
            ) else (
              call "${{ steps.vc.outputs.vcvars }}" %VCVARS_ARCH% -vcvars_ver=%VCVARS_VER%
            )
          ) else (
            rem Fall back to default toolset if mapping missing
            if defined WINSDK (
              call "${{ steps.vc.outputs.vcvars }}" %VCVARS_ARCH% -winsdk=%WINSDK%
            ) else (
              call "${{ steps.vc.outputs.vcvars }}" %VCVARS_ARCH%
            )
          )
          if errorlevel 1 exit /b 1

          cd /d "build\Judy-%VER%\src"
          call build.bat
          if errorlevel 1 exit /b 1

          if not exist Judy.lib (
            echo FATAL: Judy.lib not produced. >&2
            dir /b
            exit /b 1
          )

      - name: Install headers and libraries
        run: |
          set VER=1.0.5
          set PREFIX=%CD%\install

          if not exist "%PREFIX%\include" mkdir "%PREFIX%\include"
          if not exist "%PREFIX%\lib" mkdir "%PREFIX%\lib"
          if not exist "%PREFIX%\bin" mkdir "%PREFIX%\bin"

          copy /Y "build\Judy-%VER%\src\Judy.h" "%PREFIX%\include\Judy.h" >nul
          copy /Y "build\Judy-%VER%\src\Judy.lib" "%PREFIX%\lib\Judy.lib" >nul
          if exist "build\Judy-%VER%\src\Judy.dll" copy /Y "build\Judy-%VER%\src\Judy.dll" "%PREFIX%\bin\Judy.dll" >nul
          if exist "build\Judy-%VER%\COPYING" copy /Y "build\Judy-%VER%\COPYING" "%PREFIX%\COPYING" >nul

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjudy-1.0.5-${{steps.virtuals.outputs.vs}}-${{matrix.arch}}
          path: install
